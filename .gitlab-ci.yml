.go-cache:
  image: golang:1.18
  variables:
    GOPATH: $CI_PROJECT_DIR/.go
  before_script:
    - mkdir -p .go
  cache:
    paths:
      - .go/pkg/mod/

stages:
  - lint
  - test
  - build
  - release

lint:
  extends: .go-cache
  stage: lint
  script:
    - go vet $(go list ./... | grep -v /vendor/)

test:
  extends: .go-cache
  stage: test
  script:
    - go test ./... -v -short

build:
  extends: .go-cache
  stage: build
  script:
    - mkdir -p bin
    - go build -o bin ./...
  artifacts:
    paths:
      - bin

release:
  extends: .go-cache
  stage: release
  image:
    name: goreleaser/goreleaser
    entrypoint: ['']
  only:
    - tags
  variables:
    GIT_DEPTH: 0
  script:
    - goreleaser release --rm-dist
